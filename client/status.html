<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <link rel="icon" href="/.well-known/epistery/favicon.ico">
  <title>Epistery Status - {{server.domain}}</title>
  <script type="module">
    import Witness from '/.well-known/epistery/lib/witness.js';
    import Export from '/.well-known/epistery/lib/export.js';

    let witness = null;
    
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Connect to Epistery and get/create client wallet
        witness = await Witness.connect();
        
        const status = witness.getStatus();
        
        // Update UI with client wallet info
        if (status.client) {
            document.getElementById('local-wallet-address').textContent = status.client.address;
            document.getElementById('local-wallet-public-key').textContent = status.client.publicKey;
            document.getElementById('wallet-source').textContent = status.client.source === 'local' ? 'Browser Wallet (localStorage)' : 'Web3 Wallet (MetaMask/Plugin)';
        } else {
            document.getElementById('local-wallet-address').textContent = 'No wallet found';
            document.getElementById('local-wallet-public-key').textContent = 'No wallet found';
            document.getElementById('wallet-source').textContent = 'N/A';
        }

        // Setup wallet management UI
        await setupWalletManagement();

        // Setup Identity Contract UI
        await setupIdentityContract();

        // Set up export wallet functionality
        const exportSection = document.getElementById('export-section');
        const exportButton = document.getElementById('export-button');
        const exportPrivateKeyButton = document.getElementById('export-privatekey-button');
        const exportMnemonicButton = document.getElementById('export-mnemonic-button');
        const exportOutput = document.getElementById('export-output');

        const exportData = Export.getWalletExportData(witness);

        if (exportData.canExport) {
          exportSection.style.display = 'block';

          exportButton.onclick = () => {
            const dataToExport = Export.formatForMetaMask(exportData);
            Export.downloadAsJSON(dataToExport, `epistery-wallet-${exportData.address.substring(0, 8)}.json`);

            exportOutput.innerHTML = `
              <div class="success">
                <h4>Wallet Exported!</h4>
                <p>Your wallet has been downloaded as a JSON file.</p>
                <p><strong>Next Steps:</strong></p>
                <ol>
                  <li>Open MetaMask or your preferred Web3 wallet</li>
                  <li>Look for "Import Account" or "Import Private Key"</li>
                  <li>Copy your private key from the downloaded file</li>
                  <li>Paste it into the import field</li>
                </ol>
                <p class="warning-text">‚ö†Ô∏è Keep your private key secure and never share it!</p>
              </div>
            `;
          };

          exportPrivateKeyButton.onclick = async () => {
            try {
              await Export.copyToClipboard(exportData.privateKey);
              exportOutput.innerHTML = `
                <div class="success">
                  <h4>Private Key Copied!</h4>
                  <p>Your private key has been copied to the clipboard.</p>
                  <p><strong>Private Key:</strong> <code class="private-key-display">${exportData.privateKey}</code></p>
                  <p class="warning-text">‚ö†Ô∏è Anyone with this key can control your wallet. Keep it secure!</p>
                </div>
              `;
            } catch (error) {
              exportOutput.innerHTML = `
                <div class="error">
                  <h4>Copy Failed</h4>
                  <p>Could not copy to clipboard. Here is your private key:</p>
                  <p><code class="private-key-display">${exportData.privateKey}</code></p>
                </div>
              `;
            }
          };

          exportMnemonicButton.onclick = async () => {
            if (exportData.mnemonic) {
              try {
                await Export.copyToClipboard(exportData.mnemonic);
                exportOutput.innerHTML = `
                  <div class="success">
                    <h4>Recovery Phrase Copied!</h4>
                    <p>Your 12-word recovery phrase has been copied to the clipboard.</p>
                    <p><strong>Recovery Phrase:</strong> <code class="private-key-display">${exportData.mnemonic}</code></p>
                    <p class="warning-text">‚ö†Ô∏è Anyone with this phrase can control your wallet. Keep it secure!</p>
                  </div>
                `;
              } catch (error) {
                exportOutput.innerHTML = `
                  <div class="error">
                    <h4>Copy Failed</h4>
                    <p>Could not copy to clipboard. Here is your recovery phrase:</p>
                    <p><code class="private-key-display">${exportData.mnemonic}</code></p>
                  </div>
                `;
              }
            } else {
              exportOutput.innerHTML = `
                <div class="error">
                  <h4>No Recovery Phrase</h4>
                  <p>This wallet does not have a recovery phrase available.</p>
                </div>
              `;
            }
          };
        } else {
          exportSection.style.display = 'none';
        }

        // Set up write event button
        const writeButton = document.getElementById('write-button');
        const writeInput = document.getElementById('write-input');
        const writeOutput = document.getElementById('write-output');

        writeButton.onclick = async () => {
          try {
            writeButton.disabled = true;
            writeButton.textContent = 'Writing...';
            writeOutput.innerHTML = '<div class="loading">Submitting to Epistery...</div>';

            const inputData = writeInput.value || 'Default test message';

            const result = await witness.writeEvent({
              message: inputData,
              timestamp: new Date().toISOString(),
              page: 'status',
              url: location.href
            });

            writeOutput.innerHTML = `
              <div class="success">
                <h4>Write Successful!</h4>
                <div class="result-section">
                  <h5>IPFS Storage:</h5>
                  <p><strong>Hash:</strong> <code>${result.ipfsHash}</code></p>
                  <p><strong>URL:</strong> <a href="${result.ipfsUrl}" target="_blank">${result.ipfsUrl}</a></p>
                </div>
                <div class="result-section">
                  <h5>Cryptographic Proof:</h5>
                  <p><strong>Message Hash:</strong> <code>${result.messageHash}</code></p>
                  <p><strong>Signature:</strong> <code>${result.signature}</code></p>
                  <p><strong>Signed By:</strong> <code>${result.signedBy}</code></p>
                </div>
                <div class="result-section">
                  <h5>Metadata:</h5>
                  <p><strong>Timestamp:</strong> ${result.timestamp}</p>
                  <p><strong>Client Address:</strong> <code>${result.client.address}</code></p>
                  <p><strong>Server Domain:</strong> ${result.server.domain}</p>
                </div>
                <div class="result-section">
                  <h5>Raw Data:</h5>
                  <pre><code>${JSON.stringify(result.data, null, 2)}</code></pre>
                </div>
                ${result.aquaTree ? `
                <div class="result-section">
                  <h5>Aqua Tree:</h5>
                  <pre><code>${JSON.stringify(result.aquaTree, null, 2)}</code></pre>
                </div>
                ` : ''}
              </div>
            `;

            writeInput.value = '';
          }
          catch (error) {
            writeOutput.innerHTML = `
              <div class="error">
                  <h4>Write Failed</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                  <pre><code>${error.stack || 'No stack trace available'}</code></pre>
              </div>
            `;
          }
          finally {
            writeButton.disabled = false;
            writeButton.textContent = 'Write to Epistery';
          }
        };

        // Set up read event button
        const readButton = document.getElementById('read-button');
        const readOutput = document.getElementById('read-output');

        readButton.onclick = async () => {
          try {
            readButton.disabled = true;
            readButton.textContent = 'Reading...';
            readOutput.innerHTML = '<div class="loading">Reading from Agent contract...</div>';

            const result = await witness.readEvent();

            if (!result || !result.messages || result.messages.length === 0) {
              readOutput.innerHTML = `
                <div class="error">
                  <h4>No Data Found</h4>
                  <p>No data has been written to the contract for this wallet yet.</p>
                </div>
              `;
              return;
            }

            // Display messages from newest to oldest (reverse array)
            const messages = [...result.messages].reverse();

            let messagesHtml = '';
            messages.forEach((message, idx) => {
              const messageNumber = result.count - idx;

              if (message.error) {
                messagesHtml += `
                  <div class="message-card message-error">
                    <div class="message-header">
                      <span class="message-number">Message #${messageNumber}</span>
                      <span class="message-status error">‚ö†Ô∏è Error Loading</span>
                    </div>
                    <div class="message-body">
                      <p><strong>IPFS Hash:</strong> <code>${message.ipfsHash}</code></p>
                      <p><strong>Error:</strong> ${message.error}</p>
                    </div>
                  </div>
                `;
              } else {
                const data = message.data;
                messagesHtml += `
                  <div class="message-card">
                    <div class="message-header">
                      <span class="message-number">Message #${messageNumber}</span>
                      <span class="message-timestamp">${data.timestamp || 'N/A'}</span>
                    </div>
                    <div class="message-body">
                      <div class="message-section">
                        <p><strong>IPFS Hash:</strong> <code class="hash-code">${message.ipfsHash}</code></p>
                        <p><strong>IPFS URL:</strong> <a href="${message.ipfsUrl}" target="_blank" class="ipfs-link">View on IPFS</a></p>
                      </div>
                      <div class="message-section">
                        <p><strong>Signature:</strong> <code class="sig-code">${data.signature ? data.signature.substring(0, 20) + '...' : 'N/A'}</code></p>
                        <p><strong>Signed By:</strong> <code>${data.signedBy || 'N/A'}</code></p>
                      </div>
                      <div class="message-section">
                        <p><strong>Data:</strong></p>
                        <div class="message-data">
                          <pre><code>${JSON.stringify(data.data, null, 2)}</code></pre>
                        </div>
                      </div>
                      <details class="message-details">
                        <summary>View Full Details</summary>
                        <div class="message-section">
                          <h6>Cryptographic Proof:</h6>
                          <p><strong>Message Hash:</strong> <code>${data.messageHash || 'N/A'}</code></p>
                          <p><strong>Full Signature:</strong> <code>${data.signature || 'N/A'}</code></p>
                        </div>
                        <div class="message-section">
                          <h6>Client Info:</h6>
                          <p><strong>Address:</strong> <code>${data.client?.address || 'N/A'}</code></p>
                          <p><strong>Public Key:</strong> <code>${data.client?.publicKey || 'N/A'}</code></p>
                        </div>
                        <div class="message-section">
                          <h6>Server Info:</h6>
                          <p><strong>Domain:</strong> ${data.server?.domain || 'N/A'}</p>
                          <p><strong>Address:</strong> <code>${data.server?.address || 'N/A'}</code></p>
                        </div>
                        ${data.aquaTree ? `
                        <div class="message-section">
                          <h6>Aqua Tree:</h6>
                          <pre><code>${JSON.stringify(data.aquaTree, null, 2)}</code></pre>
                        </div>
                        ` : ''}
                        <div class="message-section">
                          <h6>Full IPFS Data:</h6>
                          <pre><code>${JSON.stringify(data, null, 2)}</code></pre>
                        </div>
                      </details>
                    </div>
                  </div>
                `;
              }
            });

            readOutput.innerHTML = `
              <div class="success">
                <div class="messages-summary">
                  <h4>Read Successful!</h4>
                  <p>Found <strong>${result.count}</strong> message(s) stored on the blockchain</p>
                </div>
                <div class="messages-timeline">
                  ${messagesHtml}
                </div>
              </div>
            `;
          }
          catch (error) {
            readOutput.innerHTML = `
              <div class="error">
                  <h4>Read Failed</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                  <pre><code>${error.stack || 'No stack trace available'}</code></pre>
              </div>
            `;
          }
          finally {
            readButton.disabled = false;
            readButton.textContent = 'Read from Contract';
          }
        };

        // Set up transfer ownership event button
        const transferButton = document.getElementById('transfer-button');
        const transferInput = document.getElementById('transfer-input');
        const transferOutput = document.getElementById('transfer-output');

        transferButton.onclick = async () => {
          try {
            transferButton.disabled = true;
            transferButton.textContent = 'Transferring...';
            transferOutput.innerHTML = '<div class="loading">Transferring ownership...</div>';

            const newOwnerAddress = transferInput.value.trim();

            if (!newOwnerAddress) {
              transferOutput.innerHTML = `
                <div class="error">
                  <h4>Invalid Input</h4>
                  <p>Please enter a valid wallet address.</p>
                </div>
              `;
              return;
            }

            // Validate Ethereum address format
            if (!/^0x[a-fA-F0-9]{40}$/.test(newOwnerAddress)) {
              transferOutput.innerHTML = `
                <div class="error">
                  <h4>Invalid Address</h4>
                  <p>Please enter a valid Ethereum address (0x followed by 40 hexadecimal characters).</p>
                </div>
              `;
              return;
            }

            const result = await witness.transferOwnershipEvent(newOwnerAddress);

            transferOutput.innerHTML = `
              <div class="success">
                <h4>Ownership Transfer Successful!</h4>
                <div class="result-section">
                  <h5>Transfer Details:</h5>
                  <p><strong>New Owner:</strong> <code>${newOwnerAddress}</code></p>
                  <p><strong>Previous Owner:</strong> <code>${status.client.address}</code></p>
                </div>
                <div class="result-section">
                  <h5>Important Notice:</h5>
                  <p>‚ö†Ô∏è Your data has been transferred to the new owner. You no longer have access to this data from your current wallet.</p>
                  <p>The new owner can now read and manage this data using their wallet.</p>
                </div>
              </div>
            `;

            transferInput.value = '';
          }
          catch (error) {
            transferOutput.innerHTML = `
              <div class="error">
                  <h4>Transfer Failed</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                  <pre><code>${error.stack || 'No stack trace available'}</code></pre>
              </div>
            `;
          }
          finally {
            transferButton.disabled = false;
            transferButton.textContent = 'Transfer Ownership';
          }
        };
        // Wallet Management Functions
        async function setupWalletManagement() {
          const walletList = document.getElementById('wallet-list');
          const addWeb3Button = document.getElementById('add-web3-wallet');
          const addBrowserButton = document.getElementById('add-browser-wallet');
          const walletManagementOutput = document.getElementById('wallet-management-output');

          function renderWalletList() {
            const walletsInfo = witness.getWallets();

            if (walletsInfo.wallets.length === 0) {
              walletList.innerHTML = '<p>No wallets available</p>';
              return;
            }

            let walletsHtml = '<table><tr><th>Label</th><th>Address</th><th>Type</th><th>Actions</th></tr>';
            walletsInfo.wallets.forEach(wallet => {
              const isDefault = wallet.isDefault;
              walletsHtml += `
                <tr class="${isDefault ? 'default-wallet' : ''}">
                  <td>${wallet.label}${isDefault ? ' <strong>(Default)</strong>' : ''}</td>
                  <td class="address">${wallet.address.substring(0, 10)}...${wallet.address.substring(wallet.address.length - 8)}</td>
                  <td>${wallet.source === 'web3' ? 'Web3' : 'Browser'}</td>
                  <td>
                    ${!isDefault ? `<button class="action-button" onclick="switchWallet('${wallet.id}')">Set Default</button>` : ''}
                    ${!isDefault && walletsInfo.wallets.length > 1 ? `<button class="action-button danger" onclick="removeWallet('${wallet.id}')">Remove</button>` : ''}
                  </td>
                </tr>
              `;
            });
            walletsHtml += '</table>';

            walletList.innerHTML = walletsHtml;
          }

          // Add Web3 wallet button
          addWeb3Button.onclick = async () => {
            try {
              addWeb3Button.disabled = true;
              addWeb3Button.textContent = 'Connecting...';
              walletManagementOutput.innerHTML = '<div class="loading">Requesting Web3 wallet connection...</div>';

              const newWallet = await witness.addWeb3Wallet();

              walletManagementOutput.innerHTML = `
                <div class="success">
                  <h4>Web3 Wallet Added!</h4>
                  <p><strong>Address:</strong> <code>${newWallet.address}</code></p>
                  <p>You can now switch to this wallet as your default.</p>
                </div>
              `;

              renderWalletList();
            } catch (error) {
              walletManagementOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Add Web3 Wallet</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                  ${error.message.includes('cancelled') ? '<p>If you cancelled the MetaMask popup by accident, click the button again to retry.</p>' : ''}
                </div>
              `;
            } finally {
              addWeb3Button.disabled = false;
              addWeb3Button.textContent = 'Add Web3 Wallet (MetaMask)';
            }
          };

          // Add Browser wallet button
          addBrowserButton.onclick = async () => {
            try {
              addBrowserButton.disabled = true;
              addBrowserButton.textContent = 'Creating...';
              walletManagementOutput.innerHTML = '<div class="loading">Creating new browser wallet...</div>';

              const newWallet = await witness.addBrowserWallet();

              walletManagementOutput.innerHTML = `
                <div class="success">
                  <h4>Browser Wallet Added!</h4>
                  <p><strong>Address:</strong> <code>${newWallet.address}</code></p>
                  <p>You can now switch to this wallet as your default.</p>
                </div>
              `;

              renderWalletList();
            } catch (error) {
              walletManagementOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Add Browser Wallet</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                </div>
              `;
            } finally {
              addBrowserButton.disabled = false;
              addBrowserButton.textContent = 'Add Browser Wallet';
            }
          };

          // Switch wallet function (global so onclick can access it)
          window.switchWallet = async (walletId) => {
            try {
              walletManagementOutput.innerHTML = '<div class="loading">Switching wallet...</div>';

              await witness.setDefaultWallet(walletId);

              walletManagementOutput.innerHTML = `
                <div class="success">
                  <h4>Wallet Switched!</h4>
                  <p>The page will reload to use the new default wallet.</p>
                </div>
              `;

              // Reload the page to update all UI elements with the new wallet
              setTimeout(() => location.reload(), 1500);
            } catch (error) {
              walletManagementOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Switch Wallet</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                </div>
              `;
            }
          };

          // Remove wallet function (global so onclick can access it)
          window.removeWallet = async (walletId) => {
            if (!confirm('Are you sure you want to remove this wallet? This action cannot be undone.')) {
              return;
            }

            try {
              walletManagementOutput.innerHTML = '<div class="loading">Removing wallet...</div>';

              witness.removeWallet(walletId);

              walletManagementOutput.innerHTML = `
                <div class="success">
                  <h4>Wallet Removed!</h4>
                  <p>The wallet has been removed from your browser storage.</p>
                </div>
              `;

              renderWalletList();
            } catch (error) {
              walletManagementOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Remove Wallet</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                </div>
              `;
            }
          };

          // Initial render
          renderWalletList();
        }

        // Identity Contract Functions
        async function setupIdentityContract() {
          const identitySection = document.getElementById('identity-contract-section');
          const identityStatus = document.getElementById('identity-status');
          const identityOutput = document.getElementById('identity-output');
          const deployButton = document.getElementById('deploy-identity-button');
          const generateTokenButton = document.getElementById('generate-join-token-button');
          const acceptTokenButton = document.getElementById('accept-join-token-button');
          const joinTokenInputSection = document.getElementById('join-token-input-section');
          const submitJoinTokenButton = document.getElementById('submit-join-token-button');
          const joinTokenInput = document.getElementById('join-token-input');

          // Only show for rivet wallets
          if (witness.wallet?.source !== 'rivet') {
            identitySection.style.display = 'none';
            return;
          }

          identitySection.style.display = 'block';

          // Display current identity status
          function updateIdentityStatus() {
            const wallet = witness.wallet;

            if (wallet.contractAddress) {
              identityStatus.innerHTML = `
                <h4>‚úÖ Identity Contract Active</h4>
                <p><strong>Contract Address:</strong> <code>${wallet.contractAddress}</code></p>
                <p><strong>Rivet Address:</strong> <code>${wallet.rivetAddress || wallet.address}</code></p>
                <p><strong>Type:</strong> ${wallet.type}</p>
                <button id="view-rivets-button" class="action-button" style="margin-top: 10px;">üë• View All Rivets</button>
              `;
              deployButton.style.display = 'none';
              generateTokenButton.style.display = 'inline-block';
              acceptTokenButton.style.display = 'inline-block';

              // Add event listener for view rivets button
              document.getElementById('view-rivets-button').onclick = async () => {
                try {
                  const viewButton = document.getElementById('view-rivets-button');
                  viewButton.disabled = true;
                  viewButton.textContent = '‚è≥ Loading...';
                  identityOutput.innerHTML = '<div class="loading">Fetching rivets from blockchain...</div>';

                  const providerConfig = {
                    rpc: witness.serverInfo.rpc,
                    chainId: witness.serverInfo.chainId
                  };

                  const rivets = await witness.wallet.getRivetsInContract(window.ethers, providerConfig);

                  let rivetsListHTML = '';
                  rivets.forEach((rivet, index) => {
                    const isCurrentRivet = rivet.address.toLowerCase() === (witness.wallet.rivetAddress || witness.wallet.address).toLowerCase();
                    rivetsListHTML += `
                      <tr ${isCurrentRivet ? 'class="current-rivet"' : ''}>
                        <td>${index + 1}</td>
                        <td><strong>${rivet.name || 'Unnamed Rivet'}</strong></td>
                        <td><code>${rivet.address}</code></td>
                        <td>${isCurrentRivet ? '<strong>(This Device)</strong>' : ''}</td>
                      </tr>
                    `;
                  });

                  identityOutput.innerHTML = `
                    <div class="success">
                      <h4>üë• Authorized Rivets</h4>
                      <p>Found <strong>${rivets.length}</strong> rivet(s) authorized to use this identity:</p>
                      <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <tr style="background-color: #007bff; color: white;">
                          <th style="padding: 10px; text-align: left;">#</th>
                          <th style="padding: 10px; text-align: left;">Name</th>
                          <th style="padding: 10px; text-align: left;">Rivet Address</th>
                          <th style="padding: 10px; text-align: left;">Status</th>
                        </tr>
                        ${rivetsListHTML}
                      </table>
                      <style>
                        .current-rivet { background-color: #d4edda; }
                        table tr:not(:first-child) { border-bottom: 1px solid #dee2e6; }
                        table td { padding: 10px; }
                      </style>
                    </div>
                  `;

                  viewButton.disabled = false;
                  viewButton.textContent = 'üë• View All Rivets';
                } catch (error) {
                  identityOutput.innerHTML = `
                    <div class="error">
                      <h4>Failed to Load Rivets</h4>
                      <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                  `;
                  document.getElementById('view-rivets-button').disabled = false;
                  document.getElementById('view-rivets-button').textContent = 'üë• View All Rivets';
                }
              };
            } else {
              identityStatus.innerHTML = `
                <h4>üì± Rivet Wallet</h4>
                <p><strong>Address:</strong> <code>${wallet.address}</code></p>
                <p><strong>Status:</strong> Not upgraded to Identity Contract</p>
                <p><i>You can either deploy a new Identity Contract, or join an existing one using a token from another device.</i></p>
              `;
              deployButton.style.display = 'inline-block';
              generateTokenButton.style.display = 'none';
              acceptTokenButton.style.display = 'inline-block'; // Show join button for fresh rivets!
            }
          }

          updateIdentityStatus();

          // Deploy Identity Contract
          deployButton.onclick = async () => {
            try {
              deployButton.disabled = true;
              deployButton.textContent = '‚è≥ Deploying...';
              identityOutput.innerHTML = '<div class="loading">Deploying Identity Contract to blockchain...</div>';

              const providerConfig = {
                rpc: witness.serverInfo.rpc,
                chainId: witness.serverInfo.chainId,
                networkName: witness.serverInfo.provider,
                nativeCurrency: witness.serverInfo.nativeCurrency
              };

              const contractAddress = await witness.wallet.deployIdentityContract(window.ethers, providerConfig);

              witness.save(); // Save updated wallet
              updateIdentityStatus();

              identityOutput.innerHTML = `
                <div class="success">
                  <h4>üéâ Identity Contract Deployed!</h4>
                  <p><strong>Contract Address:</strong> <code>${contractAddress}</code></p>
                  <p>Your rivet has been upgraded to a portable identity contract.</p>
                  <p>You can now generate a join token to add this identity from other devices.</p>
                </div>
              `;
            } catch (error) {
              // Parse error for better UX
              let errorHTML = '';
              const wallet = witness.wallet;
              const rivetAddress = wallet.rivetAddress || wallet.address;

              // Check for gas price too low error
              if (error.message && error.message.includes('gas price below minimum')) {
                // Extract gas tip values
                let currentTip = 'unknown';
                let minimumTip = 'unknown';

                const tipMatch = error.message.match(/gas tip cap (\d+), minimum needed (\d+)/);
                if (tipMatch) {
                  currentTip = (parseFloat(tipMatch[1]) / 1e9).toFixed(2) + ' Gwei';
                  minimumTip = (parseFloat(tipMatch[2]) / 1e9).toFixed(2) + ' Gwei';
                }

                errorHTML = `
                  <div class="error">
                    <h4>‚õΩ Gas Price Too Low</h4>
                    <p>The transaction gas price is below the network's minimum requirement.</p>

                    <div class="result-section">
                      <h5>Gas Price Issue:</h5>
                      <p><strong>Your Gas Tip:</strong> ${currentTip}</p>
                      <p><strong>Network Minimum:</strong> ${minimumTip}</p>
                      <p>The network requires a higher gas tip to process this transaction.</p>
                    </div>

                    <div class="result-section">
                      <h5>Rivet Address:</h5>
                      <p><code>${rivetAddress}</code></p>
                      <button onclick="navigator.clipboard.writeText('${rivetAddress}').then(() => alert('Address copied to clipboard!'))" class="action-button">üìã Copy Address</button>
                    </div>

                    <div class="result-section">
                      <h5>Next Steps:</h5>
                      <ol>
                        <li>Send more POL to your rivet address above</li>
                        <li>Recommended amount: <strong>0.01 POL</strong> (ensures sufficient funds for higher gas)</li>
                        <li>Wait for transaction confirmation</li>
                        <li>Click "Deploy Identity Contract" again</li>
                      </ol>
                      <p><em>Note: Having more POL allows the wallet to use higher gas prices when needed.</em></p>
                    </div>

                    <details style="margin-top: 15px;">
                      <summary>View Technical Details</summary>
                      <pre><code>${error.message}</code></pre>
                    </details>
                  </div>
                `;
              } else if (error.message && error.message.includes('insufficient funds')) {
                // Try to extract gas estimation from error
                let gasEstimate = 'unknown';

                // Common error patterns
                const gasMatch = error.message.match(/(\d+)\s*wei/i);
                if (gasMatch) {
                  const weiNeeded = gasMatch[1];
                  const ethNeeded = (parseFloat(weiNeeded) / 1e18).toFixed(6);
                  gasEstimate = `${ethNeeded} POL (${weiNeeded} wei)`;
                }

                errorHTML = `
                  <div class="error">
                    <h4>üí∞ Insufficient Funds</h4>
                    <p>Your rivet wallet does not have enough funds to deploy the Identity Contract.</p>

                    <div class="result-section">
                      <h5>Rivet Address:</h5>
                      <p><code>${rivetAddress}</code></p>
                      <button onclick="navigator.clipboard.writeText('${rivetAddress}').then(() => alert('Address copied to clipboard!'))" class="action-button">üìã Copy Address</button>
                    </div>

                    <div class="result-section">
                      <h5>Network:</h5>
                      <p><strong>Chain:</strong> ${witness.serverInfo.provider || 'Unknown'}</p>
                      <p><strong>Chain ID:</strong> ${witness.serverInfo.chainId || 'Unknown'}</p>
                      ${gasEstimate !== 'unknown' ? `<p><strong>Estimated Cost:</strong> ~${gasEstimate}</p>` : ''}
                    </div>

                    <div class="result-section">
                      <h5>Next Steps:</h5>
                      <ol>
                        <li>Copy the rivet address above</li>
                        <li>Send POL (Polygon Amoy testnet tokens) to this address</li>
                        <li>Recommended amount: <strong>0.01 POL</strong> (includes gas + buffer)</li>
                        <li>Wait for transaction confirmation</li>
                        <li>Click "Deploy Identity Contract" again</li>
                      </ol>
                    </div>

                    <details style="margin-top: 15px;">
                      <summary>View Technical Details</summary>
                      <pre><code>${error.message}</code></pre>
                    </details>
                  </div>
                `;
              } else {
                errorHTML = `
                  <div class="error">
                    <h4>Deployment Failed</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <pre><code>${error.stack || 'No stack trace available'}</code></pre>
                  </div>
                `;
              }

              identityOutput.innerHTML = errorHTML;
            } finally {
              deployButton.disabled = false;
              deployButton.textContent = 'üöÄ Deploy Identity Contract';
            }
          };

          // Add Rivet to Identity (new secure flow)
          generateTokenButton.onclick = async () => {
            // Show input form for URL or address
            identityOutput.innerHTML = `
              <div class="input-section">
                <h4>‚ûï Add Rivet to Identity</h4>
                <p>Enter the website URL or rivet address of the device you want to add:</p>
                <input type="text" id="rivet-target-input"
                  placeholder="e.g., localhost:3000 or 0x742d35..."
                  style="width: 100%; padding: 10px; margin: 10px 0; font-family: monospace;">
                <p class="info-text">
                  üí° <strong>Tip:</strong> Enter a website URL to automatically fetch that site's rivet address,
                  or paste the rivet address directly.
                </p>
                <button id="submit-target-button" class="action-button">üîó Generate Token & Authorize</button>
                <button onclick="document.getElementById('identity-output').innerHTML = ''" class="action-button" style="background: #666;">Cancel</button>
              </div>
            `;

            // Handle the submit
            document.getElementById('submit-target-button').onclick = async () => {
              try {
                const submitButton = document.getElementById('submit-target-button');
                const targetInput = document.getElementById('rivet-target-input').value.trim();

                if (!targetInput) {
                  throw new Error('Please enter a URL or rivet address');
                }

                submitButton.disabled = true;
                submitButton.textContent = '‚è≥ Processing...';

                // Determine if input is a URL or address
                let targetAddress;
                const isAddress = /^0x[a-fA-F0-9]{40}$/.test(targetInput);

                if (isAddress) {
                  targetAddress = targetInput;
                  identityOutput.innerHTML = '<div class="loading">Using provided rivet address...</div>';
                } else {
                  // It's a URL - fetch the rivet address
                  identityOutput.innerHTML = `<div class="loading">Fetching rivet address from ${targetInput}...</div>`;
                  targetAddress = await window.RivetWallet.getRivetAddressFromURL(targetInput);
                }

                // Generate token bound to this specific address
                identityOutput.innerHTML = '<div class="loading">Generating join token for: ' + targetAddress + '</div>';
                const contractAddress = witness.wallet.contractAddress || witness.wallet.address;
                const token = await witness.wallet.generateJoinToken(targetAddress, contractAddress, window.ethers);

                // Immediately authorize the rivet on-chain
                identityOutput.innerHTML = '<div class="loading">Authorizing rivet on blockchain...</div>';
                const providerConfig = {
                  rpc: witness.serverInfo.rpc,
                  chainId: witness.serverInfo.chainId
                };
                await witness.wallet.addRivetToContract(targetAddress, window.ethers, providerConfig);

                // Success - show the token
                identityOutput.innerHTML = `
                  <div class="success">
                    <h4>‚úÖ Rivet Authorized!</h4>
                    <p><strong>Target Rivet:</strong> <code>${targetAddress}</code></p>
                    <p>The rivet has been authorized on the blockchain. Now send this token to the other device:</p>
                    <textarea readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 0.85em; padding: 10px; margin: 10px 0;">${token}</textarea>
                    <button onclick="navigator.clipboard.writeText('${token}').then(() => alert('Token copied to clipboard!'))" class="action-button">üìã Copy Token</button>
                    <p class="info-text">
                      The other device should use "Add Rivet from Token" to accept this invitation.
                      Token expires in 1 hour and can only be used by the target rivet.
                    </p>
                  </div>
                `;
              } catch (error) {
                identityOutput.innerHTML = `
                  <div class="error">
                    <h4>Failed to Add Rivet</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <button onclick="document.getElementById('generate-join-token-button').click()" class="action-button">Try Again</button>
                  </div>
                `;
              }
            };
          };

          // Show join token input
          acceptTokenButton.onclick = () => {
            joinTokenInputSection.style.display = 'block';
          };

          // Accept join token
          submitJoinTokenButton.onclick = async () => {
            try {
              submitJoinTokenButton.disabled = true;
              submitJoinTokenButton.textContent = '‚è≥ Processing...';
              identityOutput.innerHTML = '<div class="loading">Verifying join token and upgrading rivet...</div>';

              const token = joinTokenInput.value.trim();
              if (!token) {
                throw new Error('Please enter a join token');
              }

              const result = await witness.wallet.acceptJoinToken(token, window.ethers);

              witness.save(); // Save updated wallet
              updateIdentityStatus();

              identityOutput.innerHTML = `
                <div class="success">
                  <h4>‚úÖ Ready to Join!</h4>
                  <p>This rivet has been upgraded to use the identity contract.</p>
                  <p><strong>Your Rivet Address:</strong> <code>${result.myRivetAddress}</code></p>
                  <button onclick="navigator.clipboard.writeText('${result.myRivetAddress}').then(() => alert('Address copied!'))" class="action-button">üìã Copy Address</button>
                  <div class="result-section">
                    <h5>Next Step:</h5>
                    <p>Go back to your other device and provide this rivet address to complete the join process.</p>
                    <p>The other device (which deployed the contract) needs to add this address to authorize it.</p>
                  </div>
                </div>
              `;

              joinTokenInput.value = '';
              joinTokenInputSection.style.display = 'none';
            } catch (error) {
              identityOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Accept Token</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                </div>
              `;
            } finally {
              submitJoinTokenButton.disabled = false;
              submitJoinTokenButton.textContent = 'Add Rivet to Identity';
            }
          };

          // Add rivet to contract
          const addRivetSection = document.getElementById('add-rivet-section');
          const addRivetButton = document.getElementById('add-rivet-button');
          const rivetAddressInput = document.getElementById('rivet-address-input');

          // Show add-rivet section if wallet has a contract
          if (witness.wallet?.contractAddress) {
            addRivetSection.style.display = 'block';
          }

          addRivetButton.onclick = async () => {
            try {
              addRivetButton.disabled = true;
              addRivetButton.textContent = '‚è≥ Adding...';
              identityOutput.innerHTML = '<div class="loading">Adding rivet to identity contract...</div>';

              const rivetAddressToAdd = rivetAddressInput.value.trim();
              if (!rivetAddressToAdd) {
                throw new Error('Please enter a rivet address');
              }

              // Validate Ethereum address format
              if (!/^0x[a-fA-F0-9]{40}$/.test(rivetAddressToAdd)) {
                throw new Error('Invalid Ethereum address format');
              }

              const providerConfig = {
                rpc: witness.serverInfo.rpc,
                chainId: witness.serverInfo.chainId
              };

              // Step 1: Authorize the rivet on-chain
              identityOutput.innerHTML = '<div class="loading">Authorizing rivet on blockchain...</div>';
              await witness.wallet.addRivetToContract(rivetAddressToAdd, window.ethers, providerConfig);

              // Step 2: Generate join token for the rivet
              identityOutput.innerHTML = '<div class="loading">Generating join token...</div>';
              const contractAddress = witness.wallet.contractAddress || witness.wallet.address;
              const token = await witness.wallet.generateJoinToken(rivetAddressToAdd, contractAddress, window.ethers);

              // Step 3: Display success with token
              identityOutput.innerHTML = `
                <div class="success">
                  <h4>‚úÖ Rivet Authorized!</h4>
                  <p><strong>Rivet Address:</strong> <code>${rivetAddressToAdd}</code></p>
                  <p>The rivet has been authorized on the blockchain. Send this token to the other device to complete the join:</p>
                  <textarea readonly style="width: 100%; height: 100px; font-family: monospace; font-size: 0.85em; padding: 10px; margin: 10px 0;">${token}</textarea>
                  <button onclick="navigator.clipboard.writeText('${token}').then(() => alert('Token copied to clipboard!'))" class="action-button">üìã Copy Token</button>
                  <div class="result-section">
                    <h5>Next Step:</h5>
                    <p>On the other device, go to the status page and click <strong>"üì• Add Rivet from Token"</strong>, then paste this token to complete the join process.</p>
                    <p class="info-text">Token expires in 1 hour and can only be used by the authorized rivet.</p>
                  </div>
                </div>
              `;

              rivetAddressInput.value = '';
            } catch (error) {
              identityOutput.innerHTML = `
                <div class="error">
                  <h4>Failed to Add Rivet</h4>
                  <p><strong>Error:</strong> ${error.message}</p>
                  <pre><code>${error.stack || 'No stack trace available'}</code></pre>
                </div>
              `;
            } finally {
              addRivetButton.disabled = false;
              addRivetButton.textContent = 'Authorize Rivet';
            }
          };
        }
      }
      catch (error) {
        console.error('Failed to initialize Epistery:', error);
        document.getElementById('local-wallet-address').textContent = 'Error loading wallet';
        document.getElementById('local-wallet-public-key').textContent = 'Error loading wallet';
      }
    });
  </script>
  <style>
      body { font-family: Arial, sans-serif; margin: 40px; }
      .status { padding: 10px; border-radius: 5px; font-weight: bold; }
      .connected { background-color: #d4edda; color: #155724; }
      .disconnected { background-color: #f8d7da; color: #721c24; }
      .error { background-color: #f8d7da; color: #721c24; }
      .wallet-info { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; }
      .address { font-family: monospace; word-break: break-all; font-size: 0.9em; }
      .write-section { background-color: #e9ecef; padding: 20px; border-radius: 5px; margin: 20px 0; }
      .write-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; margin: 10px 0; font-size: 14px; box-sizing: border-box; }
      .write-button { background-color: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
      .write-button:hover { background-color: #0056b3; }
      .write-button:disabled { background-color: #6c757d; cursor: not-allowed; }
      .read-section { background-color: #e7f3ff; padding: 20px; border-radius: 5px; margin: 20px 0; }
      .read-button { background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; }
      .read-button:hover { background-color: #218838; }
      .read-button:disabled { background-color: #6c757d; cursor: not-allowed; }
      .export-section { background-color: #e8f5e9; padding: 20px; border-radius: 5px; margin: 20px 0; border: 2px solid #4caf50; }
      .export-buttons { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
      .export-button { background-color: #4caf50; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; flex: 1; min-width: 180px; }
      .export-button:hover { background-color: #45a049; }
      .export-button:disabled { background-color: #6c757d; cursor: not-allowed; }
      .private-key-display { background-color: #fff3cd !important; padding: 8px !important; display: block; margin: 10px 0; font-size: 0.85em; word-break: break-all; border: 1px solid #ffc107; }
      .warning-text { color: #d32f2f; font-weight: bold; margin: 10px 0; }
      .transfer-section { background-color: #fff3cd; padding: 20px; border-radius: 5px; margin: 20px 0; border: 2px solid #ffc107; }
      .transfer-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; margin: 10px 0; font-size: 14px; box-sizing: border-box; font-family: monospace; }
      .transfer-button { background-color: #ffc107; color: #212529; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
      .transfer-button:hover { background-color: #e0a800; }
      .transfer-button:disabled { background-color: #6c757d; cursor: not-allowed; color: white; }
      .success { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
      .error { background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
      .loading { background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
      .result-section { margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
      .result-section h5 { margin: 0 0 10px 0; color: #495057; }
      .result-section code { background-color: #e9ecef; padding: 2px 4px; border-radius: 2px; font-size: 0.9em; word-break: break-all; }
      .result-section pre { background-color: #f1f3f4; padding: 10px; border-radius: 3px; overflow-x: auto; white-space: pre-wrap; font-size: 0.8em; }

      /* Message Timeline Styles */
      .messages-summary { margin-bottom: 20px; padding: 15px; background-color: #e7f3ff; border-radius: 5px; border-left: 4px solid #28a745; }
      .messages-summary h4 { margin: 0 0 10px 0; color: #155724; }
      .messages-summary p { margin: 0; color: #155724; }
      .messages-timeline { display: flex; flex-direction: column; gap: 15px; }
      .message-card { background-color: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: box-shadow 0.2s; }
      .message-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
      .message-card.message-error { border-left: 4px solid #dc3545; background-color: #fff5f5; }
      .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef; }
      .message-number { font-weight: bold; font-size: 1.1em; color: #007bff; }
      .message-timestamp { font-size: 0.9em; color: #6c757d; font-family: monospace; }
      .message-status.error { color: #dc3545; font-weight: bold; }
      .message-body { }
      .message-section { margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; }
      .message-section p { margin: 5px 0; font-size: 0.95em; }
      .message-section h6 { margin: 0 0 8px 0; color: #495057; font-size: 0.9em; font-weight: bold; text-transform: uppercase; }
      .message-data { background-color: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; }
      .message-data pre { margin: 0; font-size: 0.85em; }
      .hash-code { font-family: monospace; font-size: 0.85em; word-break: break-all; }
      .sig-code { font-family: monospace; font-size: 0.85em; }
      .ipfs-link { color: #007bff; text-decoration: none; }
      .ipfs-link:hover { text-decoration: underline; }
      .message-details { margin-top: 15px; }
      .message-details summary { cursor: pointer; padding: 10px; background-color: #e9ecef; border-radius: 4px; font-weight: bold; color: #495057; user-select: none; }
      .message-details summary:hover { background-color: #dee2e6; }
      .message-details[open] summary { margin-bottom: 15px; }
      .message-details code { background-color: #f1f3f4; padding: 2px 4px; border-radius: 2px; font-size: 0.85em; word-break: break-all; }
      .message-details pre { background-color: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6; overflow-x: auto; white-space: pre-wrap; font-size: 0.8em; margin: 5px 0; }

      /* Wallet Management Styles */
      .wallet-management-section { background-color: #f0f8ff; padding: 20px; border-radius: 5px; margin: 20px 0; border: 2px solid #007bff; }
      #wallet-list table { width: 100%; border-collapse: collapse; margin: 15px 0; }
      #wallet-list th { background-color: #007bff; color: white; padding: 10px; text-align: left; }
      #wallet-list td { padding: 10px; border-bottom: 1px solid #dee2e6; }
      #wallet-list tr.default-wallet { background-color: #d4edda; }
      .wallet-actions { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
      .action-button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
      .action-button:hover { background-color: #0056b3; }
      .action-button:disabled { background-color: #6c757d; cursor: not-allowed; }
      .action-button.danger { background-color: #dc3545; }
      .action-button.danger:hover { background-color: #c82333; }

      /* Identity Contract Styles */
      .identity-contract-section { background-color: #f0fff4; padding: 20px; border-radius: 5px; margin: 20px 0; border: 2px solid #28a745; }
      .identity-status { background-color: white; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #28a745; }
      .identity-status code { background-color: #f1f3f4; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
      .identity-actions { display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
      #join-token-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
  </style>
</head>
<body>
    <h1>Epistery Status</h1>
    
    <h2>Server Wallet</h2>
    <div class="wallet-info">
        <p><strong>Domain:</strong> {{server.domain}}</p>
        <p><strong>Address:</strong> <span class="address">{{server.walletAddress}}</span></p>
        <p><strong>Provider:</strong> {{server.provider}}</p>
        <p><strong>Chain ID:</strong> {{server.chainId}}</p>
    </div>
    
    <h2>Local Client Wallet (Current Default)</h2>
    <div class="wallet-info">
        <p><strong>Address:</strong> <span id="local-wallet-address" class="address">Loading...</span></p>
        <p><strong>Public Key:</strong> <span id="local-wallet-public-key" class="address">Loading...</span></p>
        <p><strong>Source:</strong> <span id="wallet-source">Loading...</span></p>
    </div>

    <div class="wallet-management-section">
        <h2>Wallet Management</h2>
        <p>Manage multiple wallets for this site. You can add Web3 wallets (MetaMask) or browser wallets, and switch between them.</p>

        <div id="wallet-list"></div>

        <div class="wallet-actions">
            <button id="add-web3-wallet" class="action-button">Add Web3 Wallet (MetaMask)</button>
            <button id="add-browser-wallet" class="action-button">Add Browser Wallet</button>
        </div>

        <div id="wallet-management-output"></div>
    </div>

    <div id="identity-contract-section" class="identity-contract-section" style="display: none;">
        <h2>Identity Contract</h2>
        <p><i>Upgrade your rivet to a portable identity that works across devices and browsers.</i></p>
        <p>An Identity Contract lets you bind multiple rivets together into a single, unified identity.</p>

        <div id="identity-status" class="identity-status"></div>

        <div class="identity-actions">
            <button id="deploy-identity-button" class="action-button">üöÄ Deploy Identity Contract</button>
            <button id="generate-join-token-button" class="action-button" style="display: none;">üîó Generate Join Token</button>
            <button id="accept-join-token-button" class="action-button" style="display: none;">üì• Add Rivet from Token</button>
        </div>

        <div id="join-token-input-section" style="display: none; margin-top: 20px;">
            <p><strong>Enter join token from another device:</strong></p>
            <input type="text" id="join-token-input" class="write-input" placeholder="Paste join token here..." />
            <button id="submit-join-token-button" class="action-button">Process Join Token</button>
        </div>

        <div id="add-rivet-section" style="display: none; margin-top: 20px;">
            <p><strong>Add a rivet address to this identity contract:</strong></p>
            <p><em>(After another device accepts your join token, paste their rivet address here)</em></p>
            <input type="text" id="rivet-address-input" class="write-input" placeholder="Paste rivet address (0x...)" />
            <button id="add-rivet-button" class="action-button">Authorize Rivet</button>
        </div>

        <div id="identity-output"></div>
    </div>

    <div id="export-section" class="export-section" style="display: none;">
        <h2>Export Wallet to Web3 Plugin</h2>
        <p><i>This browser has a wallet unique to you and {{server.domain}}. Transfer this identity
        to a web3 plugin for security and portability.</i></p>
        <p>Export your browser wallet keys to import into MetaMask or another Web3 wallet extension.</p>
        <p class="warning-text">‚ö†Ô∏è Keep your private keys secure. Never share them with anyone!</p>

        <div class="export-buttons">
            <button id="export-button" class="export-button">Download Keys (JSON)</button>
            <button id="export-privatekey-button" class="export-button">Copy Private Key</button>
            <button id="export-mnemonic-button" class="export-button">Copy Recovery Phrase</button>
        </div>

        <div id="export-output"></div>
    </div>

    <h2>Write Event Test</h2>
    <div class="write-section">
        <p>Test the Epistery write functionality by entering a message below:</p>
        <input type="text" id="write-input" class="write-input" placeholder="Enter your message here..." />
        <button id="write-button" class="write-button">Sign Message (w/AQUA)</button>
        <div id="write-output"></div>
    </div>

    <h2>Read Event Test</h2>
    <div class="read-section">
        <p>Read your data from the Agent smart contract and IPFS:</p>
        <button id="read-button" class="read-button">Read from Contract</button>
        <div id="read-output"></div>
    </div>

    <h2>Transfer Ownership Test</h2>
    <div class="transfer-section">
        <p><strong>‚ö†Ô∏è Warning:</strong> This operation will transfer ownership of your data to another wallet address. This action cannot be undone.</p>
        <p>Enter the wallet address of the new owner:</p>
        <input type="text" id="transfer-input" class="transfer-input" placeholder="0x..." />
        <button id="transfer-button" class="transfer-button">Transfer Ownership</button>
        <div id="transfer-output"></div>
    </div>

    <h2>Timestamp</h2>
    <p><strong>Generated:</strong> {{timestamp}}</p>
</body>
</html>
