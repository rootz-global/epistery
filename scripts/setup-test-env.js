#!/usr/bin/env node
/**
 * Setup Test Environment
 *
 * Creates .test.env with generated wallet credentials for running tests.
 * If .test.env exists with missing values, fills in the missing ones.
 *
 * Usage: node scripts/setup-test-env.js
 */

const fs = require('fs');
const path = require('path');
const { ethers } = require('ethers');

const TEST_ENV_PATH = path.resolve(__dirname, '..', '.test.env');

// Default provider config
const DEFAULT_PROVIDER = {
  name: 'Polygon Amoy Testnet',
  chainId: '80002',
  rpc: 'https://rpc-amoy.polygon.technology',
  currencySymbol: 'POL',
  currencyName: 'POL',
  currencyDecimals: '18'
};

/**
 * Generate a new wallet with all required credentials
 */
function generateWallet() {
  const wallet = ethers.Wallet.createRandom();
  return {
    address: wallet.address,
    mnemonic: wallet.mnemonic.phrase,
    publicKey: wallet.publicKey,
    privateKey: wallet.privateKey
  };
}

/**
 * Parse existing .test.env file into key-value object
 */
function parseEnvFile(content) {
  const result = {};
  const lines = content.split('\n');

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed || trimmed.startsWith('#')) continue;

    const eqIndex = trimmed.indexOf('=');
    if (eqIndex === -1) continue;

    const key = trimmed.substring(0, eqIndex).trim();
    const value = trimmed.substring(eqIndex + 1).trim();
    result[key] = value;
  }

  return result;
}

/**
 * Check if a wallet value is valid (not placeholder)
 */
function isValidValue(value) {
  if (!value) return false;
  if (value === '0x...') return false;
  if (value === '0x04...') return false;
  if (value.includes('word word')) return false;
  if (value === '') return false;
  return true;
}

/**
 * Check if a wallet set is complete and valid
 */
function isWalletComplete(env, prefix) {
  const keys = ['ADDRESS', 'MNEMONIC', 'PUBLIC_KEY', 'PRIVATE_KEY'];
  return keys.every(key => isValidValue(env[`${prefix}_${key}`]));
}

/**
 * Generate .test.env content
 */
function generateEnvContent(env) {
  return `# Epistery Test Environment
# Auto-generated by scripts/setup-test-env.js

# Server wallet (contract sponsor, admin privileges)
TEST_SERVER_ADDRESS=${env.TEST_SERVER_ADDRESS}
TEST_SERVER_MNEMONIC=${env.TEST_SERVER_MNEMONIC}
TEST_SERVER_PUBLIC_KEY=${env.TEST_SERVER_PUBLIC_KEY}
TEST_SERVER_PRIVATE_KEY=${env.TEST_SERVER_PRIVATE_KEY}

# Client wallet 1 (standard client operations)
TEST_CLIENT1_ADDRESS=${env.TEST_CLIENT1_ADDRESS}
TEST_CLIENT1_MNEMONIC=${env.TEST_CLIENT1_MNEMONIC}
TEST_CLIENT1_PUBLIC_KEY=${env.TEST_CLIENT1_PUBLIC_KEY}
TEST_CLIENT1_PRIVATE_KEY=${env.TEST_CLIENT1_PRIVATE_KEY}

# Client wallet 2 (multi-wallet scenarios)
TEST_CLIENT2_ADDRESS=${env.TEST_CLIENT2_ADDRESS}
TEST_CLIENT2_MNEMONIC=${env.TEST_CLIENT2_MNEMONIC}
TEST_CLIENT2_PUBLIC_KEY=${env.TEST_CLIENT2_PUBLIC_KEY}
TEST_CLIENT2_PRIVATE_KEY=${env.TEST_CLIENT2_PRIVATE_KEY}

# Provider configuration
TEST_PROVIDER_NAME=${env.TEST_PROVIDER_NAME}
TEST_PROVIDER_CHAIN_ID=${env.TEST_PROVIDER_CHAIN_ID}
TEST_PROVIDER_RPC=${env.TEST_PROVIDER_RPC}
TEST_PROVIDER_CURRENCY_SYMBOL=${env.TEST_PROVIDER_CURRENCY_SYMBOL}
TEST_PROVIDER_CURRENCY_NAME=${env.TEST_PROVIDER_CURRENCY_NAME}
TEST_PROVIDER_CURRENCY_DECIMALS=${env.TEST_PROVIDER_CURRENCY_DECIMALS}

# Deployed contract address (optional, enables integration tests)
TEST_CONTRACT_ADDRESS=${env.TEST_CONTRACT_ADDRESS || ''}
`;
}

async function main() {
  console.log('Setting up test environment...\n');

  let env = {};
  let existingFile = false;

  // Load existing .test.env if it exists
  if (fs.existsSync(TEST_ENV_PATH)) {
    existingFile = true;
    const content = fs.readFileSync(TEST_ENV_PATH, 'utf8');
    env = parseEnvFile(content);
    console.log('Found existing .test.env, checking for missing values...\n');
  } else {
    console.log('No .test.env found, creating new one...\n');
  }

  // Generate missing wallets
  const walletPrefixes = ['TEST_SERVER', 'TEST_CLIENT1', 'TEST_CLIENT2'];

  for (const prefix of walletPrefixes) {
    if (!isWalletComplete(env, prefix)) {
      console.log(`Generating ${prefix} wallet...`);
      const wallet = generateWallet();
      env[`${prefix}_ADDRESS`] = wallet.address;
      env[`${prefix}_MNEMONIC`] = wallet.mnemonic;
      env[`${prefix}_PUBLIC_KEY`] = wallet.publicKey;
      env[`${prefix}_PRIVATE_KEY`] = wallet.privateKey;
      console.log(`  Address: ${wallet.address}`);
    } else {
      console.log(`${prefix} wallet already configured`);
      console.log(`  Address: ${env[`${prefix}_ADDRESS`]}`);
    }
  }

  // Set provider defaults if missing
  if (!isValidValue(env.TEST_PROVIDER_NAME)) {
    env.TEST_PROVIDER_NAME = DEFAULT_PROVIDER.name;
  }
  if (!isValidValue(env.TEST_PROVIDER_CHAIN_ID)) {
    env.TEST_PROVIDER_CHAIN_ID = DEFAULT_PROVIDER.chainId;
  }
  if (!isValidValue(env.TEST_PROVIDER_RPC)) {
    env.TEST_PROVIDER_RPC = DEFAULT_PROVIDER.rpc;
  }
  if (!isValidValue(env.TEST_PROVIDER_CURRENCY_SYMBOL)) {
    env.TEST_PROVIDER_CURRENCY_SYMBOL = DEFAULT_PROVIDER.currencySymbol;
  }
  if (!isValidValue(env.TEST_PROVIDER_CURRENCY_NAME)) {
    env.TEST_PROVIDER_CURRENCY_NAME = DEFAULT_PROVIDER.currencyName;
  }
  if (!isValidValue(env.TEST_PROVIDER_CURRENCY_DECIMALS)) {
    env.TEST_PROVIDER_CURRENCY_DECIMALS = DEFAULT_PROVIDER.currencyDecimals;
  }

  // Write .test.env
  const content = generateEnvContent(env);
  fs.writeFileSync(TEST_ENV_PATH, content, { mode: 0o600 });

  console.log('\n.test.env configured successfully!');
  console.log(`Provider: ${env.TEST_PROVIDER_NAME} (Chain ID: ${env.TEST_PROVIDER_CHAIN_ID})`);
  console.log('\nRun tests with: npm test');

  if (!env.TEST_CONTRACT_ADDRESS) {
    console.log('\nNote: TEST_CONTRACT_ADDRESS not set. Some integration tests will be skipped.');
    console.log('Deploy a contract with: npm run deploy:agent');
  }
}

main().catch(err => {
  console.error('Error:', err.message);
  process.exit(1);
});
